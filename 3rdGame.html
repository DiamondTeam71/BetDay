<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NumberWin! লাইভ নাম্বার গেম</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="assets/css/styles5.css">
<style>
 * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Hind Siliguri', 'Poppins', sans-serif;
  font-weight: bold;
  text-decoration: none;
}


body {
    background: url('assets/images/ponno.jpg') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    color: black;
}

header {
  background: red;
  padding: 20px;
  font-size: 26px;
  color: white;
  border-top: 4px solid black;
  border-bottom: 4px solid black;
  display: flex;
  align-items: center;   
  justify-content: center; 
  text-align: center;
  gap: 10px;  
}

.header-logo {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  border: 3px solid black;
  object-fit: cover; 
}

 .span-all {
  color: gold; 
  font-weight: bold; 
}
.game-wrap {
  margin-left: 20px;
  margin-right: 20px;
  margin-top: 20px;
  margin-bottom: 20px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.98);
  border-radius: 37px;
  border: 5px solid #000;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}

.info {
  padding: 15px;
  margin-bottom: 15px;
  border: 5px solid #000;
  border-radius: 15px;
  background: #fff;
  font-size: 20px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.balance {
  font-size: 22px;
  font-weight: 700;
}

.numbers {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.number-card {
  padding: 35px;
  border-radius: 50%;
  text-align: center;
  font-size: 26px;
  color: #fff;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
  border: 7px solid #000;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
}

.number-card:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
}

.number-card.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.msg {
  margin-top: 20px;
  padding: 15px;
  border-radius: 15px;
  border: 5px solid #000;
  background: #fdf6e3;
  font-size: 18px;
  text-align: center;
  transition: 0.3s;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.timer {
  margin-top: 15px;
  font-size: 20px;
  padding: 12px;
  border: 5px solid #000;
  border-radius: 15px;
  background: #fff;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.history-box {
  margin-top: 25px;
  padding: 20px;
  border: 5px solid #000;
  border-radius: 15px;
  background: #fff;
  max-height: 250px;
  overflow-y: auto;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.history-box h3 {
  margin-bottom: 15px;
  font-size: 22px;
  color: #1e88e5;
}

.history-box ul {
  list-style: none;
}

.history-box li {
  padding: 8px 0;
  border-bottom: 1px solid #ddd;
  font-size: 17px;
}

.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  opacity: 0;
  transition: 0.3s;
  z-index: 999;
}

.popup-overlay.active {
  visibility: visible;
  opacity: 1;
}

.popup-card {
  background: #fff;
  padding: 35px 50px;
  border-radius: 25px;
  text-align: center;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
  border: 5px solid #000;
  transform: scale(0.8);
  transition: 0.3s;
}

.popup-card.active {
  transform: scale(1);
}

.popup-card h2 {
  font-size: 36px;
  margin-bottom: 25px;
}

.popup-card p {
  font-size: 26px;
  margin-bottom: 20px;
}

.popup-card button {
  padding: 12px 30px;
  font-size: 20px;
  border: none;
  border-radius: 15px;
  background: #000;
  color: #fff;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.popup-card button:hover {
  background: #444;
  transform: scale(1.05);
}

.info input[type="number"] {
  width: 150px;
  padding: 10px 15px;
  margin-left: 10px;
  font-size: 18px;
  font-weight: bold;
  border: 3px solid #000;
  border-radius: 12px;
  outline: none;
  background: #fff;
  color: #000;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  transition: 0.3s;
}

.info input[type="number"]:hover {
  border-color: #1e88e5;
  box-shadow: 0 8px 20px rgba(30, 136, 229, 0.4);
}

.info input[type="number"]:focus {
  border-color: #ffb300;
  box-shadow: 0 8px 25px rgba(255, 179, 0, 0.5);
}

.info input[type="number"]::-webkit-outer-spin-button,
.info input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.info input[type="number"] {
  -moz-appearance: textfield;
}
</style>
</head>
<body>
<header>
  <img src="assets/images/logo.png" alt="Logo" class="header-logo">
 Number<span style="margin-left: -10px;" class="span-all">Win!</span>
</header>

<div class="game-wrap">
  <div class="info balance"><i class="fas fa-coins"></i> ব্যালেন্স: <span id="balance">0</span> টাকা</div>
  <div class="info"><i class="fas fa-bullseye"></i> বেট (১০ - ১০,০০০): <input type="number" id="betAmount" min="10" max="10000" value="10" /></div>
  <div class="timer"><i class="fas fa-hourglass-half"></i> বাকি সময়: <span id="timeLeft">--:--</span></div>
  
  <div class="numbers">
    <div class="number-card" data-number="7" style="background:#1abc9c;">7</div>
    <div class="number-card" data-number="13" style="background:#3498db;">13</div>
    <div class="number-card" data-number="21" style="background:#9b59b6;">21</div>
    <div class="number-card" data-number="25" style="background:#e67e22;">25</div>
    <div class="number-card" data-number="33" style="background:#2ecc71;">33</div>
    <div class="number-card" data-number="45" style="background:#f39c12;">45</div>
    <div class="number-card" data-number="55" style="background:#e74c3c;">55</div>
    <div class="number-card" data-number="63" style="background:#16a085;">63</div>
    <div class="number-card" data-number="77" style="background:#8e44ad;">77</div>
    <div class="number-card" data-number="88" style="background:#c0392b;">88</div>
  </div>

  <div class="msg" id="message">রাউন্ড শুরু হওয়ার জন্য অপেক্ষা করুন...</div>

  <div class="history-box">
    <h3><i class="fas fa-clock"></i> আপনাদের হিসাব!</h3>
    <ul id="historyList"></ul>
  </div>
</div>

<div class="popup-overlay" id="popup">
  <div class="popup-card" id="popupCard">
    <h2 id="popupTitle"><i class="fas fa-trophy"></i> জিতেছেন!</h2>
    <p id="popupText">আপনি 0 টাকা জিতেছেন!</p>
    <button onclick="closePopup()">ঠিক আছে</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAtqi7D6Pn6JOdrscG1gBbpaB2R3PA_3Fk",
  authDomain: "srabonprogrammer-98739.firebaseapp.com",
  databaseURL: "https://srabonprogrammer-98739-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "srabonprogrammer-98739",
  storageBucket: "srabonprogrammer-98739.appspot.com",
  messagingSenderId: "213761619015",
  appId: "1:213761619015:web:YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

const balanceEl = document.getElementById('balance');
const betInput = document.getElementById('betAmount');
const messageEl = document.getElementById('message');
const timeLeftEl = document.getElementById('timeLeft');
const numberCards = Array.from(document.querySelectorAll('.number-card'));
const popupOverlay = document.getElementById('popup');
const popupTitle = document.getElementById('popupTitle');
const popupText = document.getElementById('popupText');
const historyList = document.getElementById('historyList');

let balance = 0;
let roundActive = false;
let roundEndTime = 0;
let hasBet = false;
let currentBet = null;
let currentRoundId = null;

// লগইন চেক
auth.onAuthStateChanged(user=>{
  if(!user){ 
    alert('আপনাকে লগইন করতে হবে'); 
    setTimeout(()=>window.location.href='UserLogin.html',2000); 
    return; 
  }
  startGame(user.uid);
});

function startGame(userId){
  // ব্যালেন্স লোড
  database.ref('users/'+userId).on('value', snap=>{
    const data = snap.val() || {};
    balance = data.MainBalance || 0;
    balanceEl.textContent = balance;
  });

  // লাইভ রাউন্ড চেক
  database.ref('liveRound').on('value', snap=>{
    const data = snap.val();
    if(!data) return;

    // নতুন রাউন্ডে ক্লিয়ার হিস্ট্রি
    if(currentRoundId && currentRoundId !== data.id){
      historyList.innerHTML = '';
      hasBet = false;
      currentBet = null;
    }

    currentRoundId = data.id || Date.now();

    if(data.active){
      roundActive = true;
      roundEndTime = data.endTime;
      messageEl.textContent = "রাউন্ড চলমান, নাম্বার বেছে নিন!";
      enableBets(true);

      // ব্যবহারকারীর পূর্ববর্তী বেট চেক
      database.ref('liveRound/bets/'+userId).once('value').then(snap=>{
        const betData = snap.val();
        if(betData){
          hasBet = true;
          currentBet = betData;
          messageEl.textContent = `আপনি ইতিমধ্যেই ${betData.number} এ ${betData.bet} টাকা বেট দিয়েছেন!`;
          enableBets(false);
        } else {
          hasBet = false;
          currentBet = null;
        }
      });

      startTimer(roundEndTime);

      // এই রাউন্ডের সকল বেট লোড
      loadRoundBets(currentRoundId);

    } else {
      roundActive = false;
      messageEl.textContent = "পরবর্তী রাউন্ডের জন্য অপেক্ষা করুন...";
      enableBets(false);
      timeLeftEl.textContent = "--:--";
      hasBet = false;
      currentBet = null;
      clearInterval(window.roundTimer);
    }

    // বিজয়ী নির্ধারণ হলে, পপআপ একবারই দেখাবে
    if(data.winnerNumber && !data.popupShown){
      const winner = data.winnerNumber;
      const multiplier = data.multiplier || 1;
      checkResults(winner, multiplier, userId);
      database.ref('liveRound/popupShown').set(true);
      clearInterval(window.roundTimer);
      timeLeftEl.textContent="00:00";
    }
  });
}

function enableBets(state){
  numberCards.forEach(c=>c.classList.toggle('disabled',!state));
  betInput.disabled = !state;
}

// বেট সাবমিট
numberCards.forEach(card=>{
  card.addEventListener('click',()=>{
    if(!roundActive) return;
    if(hasBet){ alert('আপনি ইতিমধ্যেই বেট দিয়েছেন!'); return; }

    const bet = parseInt(betInput.value,10);
    if(isNaN(bet)||bet<10||bet>10000){ alert('বেট ১০ - ১০,০০০ মধ্যে!'); return; }
    if(bet>balance){ alert('পর্যাপ্ত ব্যালেন্স নেই!'); return; }

    const number = card.dataset.number;
    const userId = auth.currentUser.uid;

    database.ref('liveRound/bets/'+userId).set({number,bet}).then(()=>{
      balance -= bet;
      database.ref('users/'+userId+'/MainBalance').set(balance);
      messageEl.textContent = `আপনি ${number} এ ${bet} টাকা বেট দিয়েছেন!`;
      hasBet = true;
      currentBet = {number, bet};
      enableBets(false);
      loadRoundBets(currentRoundId); // নতুন বেট লোড
    });
  });
});

// টাইমার
function startTimer(endTime){
  clearInterval(window.roundTimer);
  window.roundTimer = setInterval(()=>{
    const now = Date.now();
    let diff = Math.floor((endTime - now)/1000);
    if(diff<=0){ clearInterval(window.roundTimer); timeLeftEl.textContent="00:00"; return; }
    const min = String(Math.floor(diff/60)).padStart(2,'0');
    const sec = String(diff%60).padStart(2,'0');
    timeLeftEl.textContent = `${min}:${sec}`;
  },500);
}

// বিজয়ী চেক
function checkResults(winnerNumber, multiplier, userId){
  database.ref('liveRound/bets/'+userId).once('value').then(snap=>{
    const betData = snap.val();
    if(!betData) return;

    database.ref('users/'+userId+'/roundHistory/'+currentRoundId).once('value').then(histSnap=>{
      if(histSnap.exists()) return;

      let amount = 0;
      if(betData.number===winnerNumber){
        amount = Math.floor(betData.bet * multiplier);
        balance += amount;
        showPopup(true, amount);
      } else {
        amount = betData.bet;
        showPopup(false, amount);
      }

      database.ref('users/'+userId+'/MainBalance').set(balance);
      saveHistory(userId, betData.number, betData.bet, winnerNumber, multiplier, currentRoundId);
    });
  });
  enableBets(false);
}

// পপআপ
function showPopup(win, amount){
  popupTitle.textContent = win ? "🎉 জিতেছেন!" : "❌ হেরেছেন!";
  popupTitle.style.color = win ? "green" : "red";
  popupText.textContent = win ? `আপনি ${amount} টাকা জিতেছেন!` : `আপনি ${amount} টাকা হারেছেন!`;
  popupOverlay.classList.add('active');
  document.getElementById('popupCard').classList.add('active');
}

function closePopup(){
  popupOverlay.classList.remove('active');
  document.getElementById('popupCard').classList.remove('active');
}

// রাউন্ড হিস্ট্রি লোড
function loadRoundBets(roundId){
  database.ref('liveRound/bets').once('value').then(snap=>{
    const val = snap.val() || {};
    const arr = Object.entries(val); // [ [userId, {number,bet}], ... ]
    historyList.innerHTML = '';
    arr.forEach(([uid, betData])=>{
      const li = document.createElement('li');
      li.textContent = `User: ${uid} | বেট: ${betData.number} (${betData.bet} টাকা)`;
      historyList.appendChild(li);
    });
  });
}

// সাধারণ হিস্ট্রি
function saveHistory(userId, betNumber, betAmount, winnerNumber, multiplier, roundId){
  const timestamp = Date.now();
  const result = betNumber===winnerNumber ? 'জিতেছেন' : 'হারেছেন';
  const record = {timestamp, betNumber, betAmount, winnerNumber, multiplier, result, roundId};
  database.ref('users/'+userId+'/roundHistory/'+roundId).set(record);
}
</script>
</body>
</html>